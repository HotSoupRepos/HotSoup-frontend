import{visit as e}from"graphql/language/visitor.mjs";import{Kind as n}from"graphql/language/kinds.mjs";import{print as t}from"graphql/language/printer.mjs";import{k as r,_ as o,s as u,C as c,m as s,a as l,b as y,c as p,d,e as k,g as v,f as x}from"./ee43d7ef.min.mjs";export{C as CombinedError,f as createRequest,j as getOperationName,a as makeErrorResult,m as makeResult,i as mergeResultPatch,h as stringifyVariables}from"./ee43d7ef.min.mjs";import{subscribe as q,share as g,map as w,filter as b,tap as O,merge as _,mergeMap as E,takeUntil as P,make as S,onPush as N,makeSubject as R,onEnd as M,onStart as A,publish as D,take as Q,switchMap as T,fromValue as F}from"wonka";function I(e,n){if(Array.isArray(e))for(var t=0;t<e.length;t++)I(e[t],n);else if("object"==typeof e&&null!==e)for(var r in e)"__typename"===r&&"string"==typeof e[r]?n[e[r]]=0:I(e[r],n);return n}function L(e){return Object.keys(I(e,{}))}var G=function(e){if(e.selectionSet&&!e.selectionSet.selections.some((function(e){return e.kind===n.FIELD&&"__typename"===e.name.value&&!e.alias})))return o({},e,{selectionSet:o({},e.selectionSet,{selections:e.selectionSet.selections.concat([{kind:n.FIELD,name:{kind:n.NAME,value:"__typename"}}])})})},J=new Map;function U(n){var t=r(n),o=J.get(t.__key);return o||(o=e(t,{Field:G,InlineFragment:G}),Object.defineProperty(o,"__key",{value:t.__key,enumerable:!1}),J.set(t.__key,o)),o}function V(e){return e&&"object"==typeof e?Object.keys(e).reduce((function(n,t){var r=e[t];return"__typename"===t?Object.defineProperty(n,"__typename",{enumerable:!1,value:r}):n[t]=Array.isArray(r)?r.map(V):r&&"object"==typeof r&&"__typename"in r?V(r):r,n}),Array.isArray(e)?[]:{}):e}function W(e){return e.toPromise=function(){return new Promise((function(n){var t=q((function(e){e.stale||e.hasNext||Promise.resolve().then((function(){t.unsubscribe(),n(e)}))}))(e)}))},e}function $(e,n,t){return t||(t=n.context),{key:n.key,query:n.query,variables:n.variables,kind:e,context:t}}function z(e,n){return $(e.kind,e,o({},e.context,{meta:o({},e.context.meta,n)}))}function B(){}function H(e,t,r){for(var o=0;o<r.length;o++)if(r[o].kind===n.FRAGMENT_DEFINITION){var i=r[o].name.value,a=u(r[o]);e.has(i)||(e.set(i,a),t.push(r[o]))}else t.push(r[o])}function K(){for(var e=arguments,t=new Map,o=[],i=[],u=Array.isArray(arguments[0])?arguments[0][0]:arguments[0]||"",a=1;a<arguments.length;a++){var c=e[a];c&&c.definitions?i.push.apply(i,c.definitions):u+=c,u+=e[0][a]}return H(t,o,r(u).definitions),H(t,o,i),r({kind:n.DOCUMENT,definitions:o})}function X(e){var n=e.kind;return"mutation"!==n&&"query"!==n}function Y(e){var n=e.forward,t=e.client,r=new Map,i=Object.create(null);function u(e){var n=$(e.kind,e);return n.query=U(e.query),n}function a(e){var n=e.context.requestPolicy;return"query"===e.kind&&"network-only"!==n&&("cache-only"===n||r.has(e.key))}return function(e){var c=g(e),s=w((function(e){var n=r.get(e.key),i=o({},n,{operation:z(e,{cacheOutcome:n?"hit":"miss"})});return"cache-and-network"===e.context.requestPolicy&&(i.stale=!0,Z(t,e)),i}))(b((function(e){return!X(e)&&a(e)}))(c)),f=O((function(e){var n=e.operation;if(n){var o=L(e.data).concat(n.context.additionalTypenames||[]);if("mutation"===e.operation.kind){for(var u=new Set,a=0;a<o.length;a++){var c=o[a],s=i[c]||(i[c]=new Set);s.forEach((function(e){u.add(e)})),s.clear()}u.forEach((function(e){r.has(e)&&(n=r.get(e).operation,r.delete(e),Z(t,n))}))}else if("query"===n.kind&&e.data){r.set(n.key,e);for(var f=0;f<o.length;f++){var l=o[f];(i[l]||(i[l]=new Set)).add(n.key)}}}}))(n(b((function(e){return"query"!==e.kind||"cache-only"!==e.context.requestPolicy}))(w((function(e){return z(e,{cacheOutcome:"miss"})}))(_([w(u)(b((function(e){return!X(e)&&!a(e)}))(c)),b((function(e){return X(e)}))(c)])))));return _([s,f])}}function Z(e,n){return e.reexecuteOperation($(n.kind,n,o({},n.context,{requestPolicy:"network-only"})))}var ee=new Set;function ne(e){var n=!(!e||!e.staleWhileRevalidate),t=!(!e||!e.includeExtensions),r={},o=[];function i(e){o.push(e.operation.key),1===o.length&&Promise.resolve().then((function(){for(var e;e=o.shift();)r[e]=null}))}var u=function(o){var u=o.client,a=o.forward;return function(o){var s=e&&"boolean"==typeof e.isClient?!!e.isClient:!u.suspense,f=g(o),l=a(b((function(e){return!r[e.key]||!!r[e.key].hasNext}))(f)),y=w((function(e){var o=function(e,n,t){return{operation:e,data:n.data?JSON.parse(n.data):void 0,extensions:t&&n.extensions?JSON.parse(n.extensions):void 0,error:n.error?new c({networkError:n.error.networkError?new Error(n.error.networkError):void 0,graphQLErrors:n.error.graphQLErrors}):void 0,hasNext:n.hasNext}}(e,r[e.key],t);return n&&!ee.has(e.key)&&(o.stale=!0,ee.add(e.key),Z(u,e)),o}))(b((function(e){return!!r[e.key]&&"network-only"!==e.context.requestPolicy}))(f));return s?y=O(i)(y):l=O((function(e){var n=e.operation;if("mutation"!==n.kind){var o=function(e,n){var t=e.hasNext,r=e.data,o=e.extensions,i=e.error,u={};return void 0!==r&&(u.data=JSON.stringify(r)),n&&void 0!==o&&(u.extensions=JSON.stringify(o)),t&&(u.hasNext=!0),i&&(u.error={graphQLErrors:i.graphQLErrors.map((function(e){return e.path||e.extensions?{message:e.message,path:e.path,extensions:e.extensions}:e.message}))},i.networkError&&(u.error.networkError=""+i.networkError)),u}(e,t);r[n.key]=o}}))(l),_([l,y])}};return u.restoreData=function(e){for(var n in e)null!==r[n]&&(r[n]=e[n])},u.extractData=function(){var e={};for(var n in r)null!=r[n]&&(e[n]=r[n]);return e},e&&e.initialState&&u.restoreData(e.initialState),u}function te(e){var n=e.forwardSubscription,r=e.enableAllOperations;return function(e){var i=e.client,u=e.forward;function a(e){var n=e.kind;return"subscription"===n||!!r&&("query"===n||"mutation"===n)}return function(e){var r=g(e),c=E((function(e){var u=e.key,a=b((function(e){return"teardown"===e.kind&&e.key===u}))(r);return P(a)(function(e){var r=n({key:e.key.toString(36),query:t(e.query),variables:e.variables,context:o({},e.context)});return S((function(n){var t,o=n.next,u=n.complete,a=!1;return Promise.resolve().then((function(){a||(t=r.subscribe({next:function(n){return o(s(e,n))},error:function(n){return o(l(e,n))},complete:function(){a||(a=!0,"subscription"===e.kind&&i.reexecuteOperation($("teardown",e,e.context)),u())}}))})),function(){a=!0,t&&t.unsubscribe()}}))}(e))}))(b(a)(r)),f=u(b((function(e){return!a(e)}))(r));return _([c,f])}}}function re(e){var n=e.forward;return function(e){return n(e)}}function oe(e){var n=e.forward,t=new Set;function r(e){var n=e.key,r=e.kind;if("teardown"===r)return t.delete(n),!0;if("query"!==r&&"subscription"!==r)return!0;var o=t.has(n);return t.add(n),!o}function o(e){e.hasNext||t.delete(e.operation.key)}return function(e){var t=b(r)(e);return O(o)(n(t))}}function ie(e){var n=e.forward;return function(e){var t=g(e),r=E((function(e){var n=e.key,r=b((function(e){return"teardown"===e.kind&&e.key===n}))(t),o=y(e),i=p(e,o),u=d(e,o);return N((function(e){}))(P(r)(k(e,i,u)))}))(b((function(e){return"query"===e.kind||"mutation"===e.kind}))(t)),o=n(b((function(e){return"query"!==e.kind&&"mutation"!==e.kind}))(t));return _([r,o])}}function ue(e){return function(e){return b((function(){return!1}))(O((function(e){}))(e))}}var ae=ue();function ce(e){return function(n){var t=n.client;return e.reduceRight((function(e,n){return n({client:t,forward:e,dispatchDebug:function(e){}})}),n.forward)}}function se(e){var n=e.onError;return function(e){var t=e.forward;return function(e){return O((function(e){var t=e.error;t&&n(t,e.operation)}))(t(e))}}}var fe=[oe,Y,ie],le=function e(n){var t=new Map,r=new Map,i=[],u=R(),a=u.source,c=u.next,s=!1;function f(e){for(s=!0,e&&c(e);e=i.shift();)c(e);s=!1}function l(e){var n=b((function(n){return n.operation.kind===e.kind&&n.operation.key===e.key&&(!n.operation.context._instance||n.operation.context._instance===e.context._instance)}))(m);return p.maskTypename&&(n=w((function(e){return o({},e,{data:V(e.data)})}))(n)),"mutation"===e.kind?Q(1)(A((function(){return f(e)}))(n)):g(M((function(){t.delete(e.key),r.delete(e.key);for(var n=i.length-1;n>=0;n--)i[n].key===e.key&&i.splice(n,1);f($("teardown",e,e.context))}))(N((function(n){t.set(e.key,n)}))(T((function(n){return"query"!==e.kind||n.stale?F(n):_([F(n),w((function(){return o({},n,{stale:!0})}))(Q(1)(b((function(n){return"query"===n.kind&&n.key===e.key&&"cache-only"!==n.context.requestPolicy}))(a)))])}))(P(b((function(n){return"teardown"===n.kind&&n.key===e.key}))(a))(n)))))}var y=this instanceof e?this:Object.create(e.prototype),p=o(y,{url:n.url,fetchOptions:n.fetchOptions,fetch:n.fetch,suspense:!!n.suspense,requestPolicy:n.requestPolicy||"cache-first",preferGetMethod:!!n.preferGetMethod,maskTypename:!!n.maskTypename,operations$:a,reexecuteOperation:function(e){("mutation"===e.kind||r.has(e.key))&&(i.push(e),s||Promise.resolve().then(f))},createOperationContext:function(e){return e||(e={}),o({},{_instance:void 0,url:p.url,fetchOptions:p.fetchOptions,fetch:p.fetch,preferGetMethod:p.preferGetMethod},e,{suspense:e.suspense||!1!==e.suspense&&p.suspense,requestPolicy:e.requestPolicy||p.requestPolicy})},createRequestOperation:function(e,n,t){v(n.query);var r=p.createOperationContext(t);return"mutation"===e&&(r._instance=[]),$(e,n,r)},executeRequestOperation:function(e){return"mutation"===e.kind?l(e):S((function(n){var i=r.get(e.key);i||r.set(e.key,i=l(e));var u="cache-and-network"===e.context.requestPolicy||"network-only"===e.context.requestPolicy;return q(n.next)(M(n.complete)(A((function(){var r=t.get(e.key);if("subscription"===e.kind)return f(e);u&&f(e),null!=r&&r===t.get(e.key)?n.next(u?o({},r,{stale:!0}):r):u||f(e)}))(i))).unsubscribe}))},executeQuery:function(e,n){var t=p.createRequestOperation("query",e,n);return p.executeRequestOperation(t)},executeSubscription:function(e,n){var t=p.createRequestOperation("subscription",e,n);return p.executeRequestOperation(t)},executeMutation:function(e,n){var t=p.createRequestOperation("mutation",e,n);return p.executeRequestOperation(t)},query:function(e,n,t){return t&&"boolean"==typeof t.suspense||(t=o({},t,{suspense:!1})),W(p.executeQuery(x(e,n),t))},readQuery:function(e,n,t){var r=null;return q((function(e){r=e}))(p.query(e,n,t)).unsubscribe(),r},subscription:function(e,n,t){return p.executeSubscription(x(e,n),t)},mutation:function(e,n,t){return W(p.executeMutation(x(e,n),t))}}),d=B,k=ce(void 0!==n.exchanges?n.exchanges:fe),m=g(k({client:p,dispatchDebug:d,forward:ue()})(a));return D(m),p},ye=le;export{le as Client,Y as cacheExchange,ce as composeExchanges,ye as createClient,re as debugExchange,oe as dedupExchange,fe as defaultExchanges,se as errorExchange,ae as fallbackExchangeIO,ie as fetchExchange,U as formatDocument,K as gql,$ as makeOperation,V as maskTypename,ne as ssrExchange,te as subscriptionExchange};
//# sourceMappingURL=urql-core.min.mjs.map
