{"version":3,"sources":["../../../src/utils/nodeModules.ts"],"sourcesContent":["import * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport yaml from 'js-yaml';\nimport path from 'path';\nimport semver from 'semver';\n\nimport * as Log from '../log';\nimport { env } from './env';\nimport { SilentError } from './errors';\nimport { logNewSection } from './ora';\n\nexport type PackageManagerName = 'npm' | 'yarn';\n\nexport function resolvePackageManager(options: {\n  yarn?: boolean;\n  npm?: boolean;\n  install?: boolean;\n}): PackageManagerName {\n  let packageManager: PackageManagerName = 'npm';\n  if (options.yarn || (!options.npm && PackageManager.shouldUseYarn())) {\n    packageManager = 'yarn';\n  } else {\n    packageManager = 'npm';\n  }\n  if (options.install) {\n    Log.log(\n      packageManager === 'yarn'\n        ? `ðŸ§¶ Using Yarn to install packages. ${chalk.dim('Pass --npm to use npm instead.')}`\n        : 'ðŸ“¦ Using npm to install packages.'\n    );\n  }\n\n  return packageManager;\n}\n\nexport async function installNodeDependenciesAsync(\n  projectRoot: string,\n  packageManager: PackageManagerName,\n  flags: { silent?: boolean; clean?: boolean } = {}\n) {\n  // Default to silent unless debugging.\n  const isSilent = flags.silent ?? !env.EXPO_DEBUG;\n  if (flags.clean && packageManager !== 'yarn') {\n    // This step can take a couple seconds, if the installation logs are enabled (with EXPO_DEBUG) then it\n    // ends up looking odd to see \"Installing JavaScript dependencies\" for ~5 seconds before the logs start showing up.\n    const cleanJsDepsStep = logNewSection('Cleaning JavaScript dependencies');\n    const time = Date.now();\n    // nuke the node modules\n    // TODO: this is substantially slower, we should find a better alternative to ensuring the modules are installed.\n    await fs.promises.rm('node_modules', { recursive: true, force: true });\n    cleanJsDepsStep.succeed(\n      `Cleaned JavaScript dependencies ${chalk.gray(Date.now() - time + 'ms')}`\n    );\n  }\n\n  const installJsDepsStep = logNewSection('Installing JavaScript dependencies');\n  try {\n    const time = Date.now();\n    await installNodeDependenciesInternalAsync(projectRoot, packageManager, { silent: isSilent });\n    installJsDepsStep.succeed(\n      `Installed JavaScript dependencies ${chalk.gray(Date.now() - time + 'ms')}`\n    );\n  } catch {\n    const message = `Something went wrong installing JavaScript dependencies, check your ${packageManager} logfile or run ${chalk.bold(\n      `${packageManager} install`\n    )} again manually.`;\n    installJsDepsStep.fail(chalk.red(message));\n    // TODO: actually show the error message from the package manager! :O\n    throw new SilentError(message);\n  }\n}\n\nasync function installNodeDependenciesInternalAsync(\n  projectRoot: string,\n  packageManager: PackageManagerName,\n  flags: { silent: boolean }\n) {\n  const options = { cwd: projectRoot, silent: flags.silent };\n  if (packageManager === 'yarn') {\n    const yarn = new PackageManager.YarnPackageManager(options);\n    const version = await yarn.versionAsync();\n    const nodeLinker = await yarn.getConfigAsync('nodeLinker');\n    if (semver.satisfies(version, '>=2.0.0-rc.24') && nodeLinker !== 'node-modules') {\n      const yarnRc = path.join(projectRoot, '.yarnrc.yml');\n      let yamlString = '';\n      try {\n        yamlString = fs.readFileSync(yarnRc, 'utf8');\n      } catch (error: any) {\n        if (error.code !== 'ENOENT') {\n          throw error;\n        }\n      }\n      const config = yamlString ? yaml.safeLoad(yamlString) : {};\n      // @ts-ignore\n      config.nodeLinker = 'node-modules';\n      !flags.silent &&\n        Log.warn(\n          `Yarn v${version} detected, enabling experimental Yarn v2 support using the node-modules plugin.`\n        );\n      !flags.silent && Log.log(`Writing ${yarnRc}...`);\n      fs.writeFileSync(yarnRc, yaml.safeDump(config));\n    }\n    await yarn.installAsync();\n  } else {\n    await new PackageManager.NpmPackageManager(options).installAsync();\n  }\n}\n"],"names":["resolvePackageManager","installNodeDependenciesAsync","PackageManager","Log","options","packageManager","yarn","npm","shouldUseYarn","install","log","chalk","dim","projectRoot","flags","isSilent","silent","env","EXPO_DEBUG","clean","cleanJsDepsStep","logNewSection","time","Date","now","fs","promises","rm","recursive","force","succeed","gray","installJsDepsStep","installNodeDependenciesInternalAsync","message","bold","fail","red","SilentError","cwd","YarnPackageManager","version","versionAsync","nodeLinker","getConfigAsync","semver","satisfies","yarnRc","path","join","yamlString","readFileSync","error","code","config","yaml","safeLoad","warn","writeFileSync","safeDump","installAsync","NpmPackageManager"],"mappings":"AAAA;;;;QAcgBA,qBAAqB,GAArBA,qBAAqB;QAsBfC,4BAA4B,GAA5BA,4BAA4B;AApCtCC,IAAAA,cAAc,mCAAM,uBAAuB,EAA7B;AACR,IAAA,MAAO,kCAAP,OAAO,EAAA;AACV,IAAA,GAAI,kCAAJ,IAAI,EAAA;AACF,IAAA,OAAS,kCAAT,SAAS,EAAA;AACT,IAAA,KAAM,kCAAN,MAAM,EAAA;AACJ,IAAA,OAAQ,kCAAR,QAAQ,EAAA;AAEfC,IAAAA,GAAG,mCAAM,QAAQ,EAAd;AACK,IAAA,IAAO,WAAP,OAAO,CAAA;AACC,IAAA,OAAU,WAAV,UAAU,CAAA;AACR,IAAA,IAAO,WAAP,OAAO,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAI9B,SAASH,qBAAqB,CAACI,OAIrC,EAAsB;IACrB,IAAIC,cAAc,GAAuB,KAAK,AAAC;IAC/C,IAAID,OAAO,CAACE,IAAI,IAAK,CAACF,OAAO,CAACG,GAAG,IAAIL,cAAc,CAACM,aAAa,EAAE,AAAC,EAAE;QACpEH,cAAc,GAAG,MAAM,CAAC;KACzB,MAAM;QACLA,cAAc,GAAG,KAAK,CAAC;KACxB;IACD,IAAID,OAAO,CAACK,OAAO,EAAE;QACnBN,GAAG,CAACO,GAAG,CACLL,cAAc,KAAK,MAAM,GACrB,CAAC,qCAAkC,EAAKM,MAAK,QAAA,CAACC,GAAG,CAAC,gCAAgC,CAAC,CAAC,CAAC,GAClF,6CAA+B,CACvC,CAAC;KACH;IAED,OAAOP,cAAc,CAAC;CACvB;AAEM,eAAeJ,4BAA4B,CAChDY,WAAmB,EACnBR,cAAkC,EAClCS,KAA4C,GAAG,EAAE,EACjD;QAEiBA,OAAY;IAD7B,sCAAsC;IACtC,MAAMC,QAAQ,GAAGD,CAAAA,OAAY,GAAZA,KAAK,CAACE,MAAM,YAAZF,OAAY,GAAI,CAACG,IAAG,IAAA,CAACC,UAAU,AAAC;IACjD,IAAIJ,KAAK,CAACK,KAAK,IAAId,cAAc,KAAK,MAAM,EAAE;QAC5C,sGAAsG;QACtG,mHAAmH;QACnH,MAAMe,eAAe,GAAGC,CAAAA,GAAAA,IAAa,AAAoC,CAAA,cAApC,CAAC,kCAAkC,CAAC,AAAC;QAC1E,MAAMC,IAAI,GAAGC,IAAI,CAACC,GAAG,EAAE,AAAC;QACxB,wBAAwB;QACxB,iHAAiH;QACjH,MAAMC,GAAE,QAAA,CAACC,QAAQ,CAACC,EAAE,CAAC,cAAc,EAAE;YAAEC,SAAS,EAAE,IAAI;YAAEC,KAAK,EAAE,IAAI;SAAE,CAAC,CAAC;QACvET,eAAe,CAACU,OAAO,CACrB,CAAC,gCAAgC,EAAEnB,MAAK,QAAA,CAACoB,IAAI,CAACR,IAAI,CAACC,GAAG,EAAE,GAAGF,IAAI,GAAG,IAAI,CAAC,CAAC,CAAC,CAC1E,CAAC;KACH;IAED,MAAMU,iBAAiB,GAAGX,CAAAA,GAAAA,IAAa,AAAsC,CAAA,cAAtC,CAAC,oCAAoC,CAAC,AAAC;IAC9E,IAAI;QACF,MAAMC,IAAI,GAAGC,IAAI,CAACC,GAAG,EAAE,AAAC;QACxB,MAAMS,oCAAoC,CAACpB,WAAW,EAAER,cAAc,EAAE;YAAEW,MAAM,EAAED,QAAQ;SAAE,CAAC,CAAC;QAC9FiB,iBAAiB,CAACF,OAAO,CACvB,CAAC,kCAAkC,EAAEnB,MAAK,QAAA,CAACoB,IAAI,CAACR,IAAI,CAACC,GAAG,EAAE,GAAGF,IAAI,GAAG,IAAI,CAAC,CAAC,CAAC,CAC5E,CAAC;KACH,CAAC,OAAM;QACN,MAAMY,OAAO,GAAG,CAAC,oEAAoE,EAAE7B,cAAc,CAAC,gBAAgB,EAAEM,MAAK,QAAA,CAACwB,IAAI,CAChI,CAAC,EAAE9B,cAAc,CAAC,QAAQ,CAAC,CAC5B,CAAC,gBAAgB,CAAC,AAAC;QACpB2B,iBAAiB,CAACI,IAAI,CAACzB,MAAK,QAAA,CAAC0B,GAAG,CAACH,OAAO,CAAC,CAAC,CAAC;QAC3C,qEAAqE;QACrE,MAAM,IAAII,OAAW,YAAA,CAACJ,OAAO,CAAC,CAAC;KAChC;CACF;AAED,eAAeD,oCAAoC,CACjDpB,WAAmB,EACnBR,cAAkC,EAClCS,KAA0B,EAC1B;IACA,MAAMV,OAAO,GAAG;QAAEmC,GAAG,EAAE1B,WAAW;QAAEG,MAAM,EAAEF,KAAK,CAACE,MAAM;KAAE,AAAC;IAC3D,IAAIX,cAAc,KAAK,MAAM,EAAE;QAC7B,MAAMC,IAAI,GAAG,IAAIJ,cAAc,CAACsC,kBAAkB,CAACpC,OAAO,CAAC,AAAC;QAC5D,MAAMqC,OAAO,GAAG,MAAMnC,IAAI,CAACoC,YAAY,EAAE,AAAC;QAC1C,MAAMC,UAAU,GAAG,MAAMrC,IAAI,CAACsC,cAAc,CAAC,YAAY,CAAC,AAAC;QAC3D,IAAIC,OAAM,QAAA,CAACC,SAAS,CAACL,OAAO,EAAE,eAAe,CAAC,IAAIE,UAAU,KAAK,cAAc,EAAE;YAC/E,MAAMI,MAAM,GAAGC,KAAI,QAAA,CAACC,IAAI,CAACpC,WAAW,EAAE,aAAa,CAAC,AAAC;YACrD,IAAIqC,UAAU,GAAG,EAAE,AAAC;YACpB,IAAI;gBACFA,UAAU,GAAGzB,GAAE,QAAA,CAAC0B,YAAY,CAACJ,MAAM,EAAE,MAAM,CAAC,CAAC;aAC9C,CAAC,OAAOK,KAAK,EAAO;gBACnB,IAAIA,KAAK,CAACC,IAAI,KAAK,QAAQ,EAAE;oBAC3B,MAAMD,KAAK,CAAC;iBACb;aACF;YACD,MAAME,MAAM,GAAGJ,UAAU,GAAGK,OAAI,QAAA,CAACC,QAAQ,CAACN,UAAU,CAAC,GAAG,EAAE,AAAC;YAC3D,aAAa;YACbI,MAAM,CAACX,UAAU,GAAG,cAAc,CAAC;YACnC,CAAC7B,KAAK,CAACE,MAAM,IACXb,GAAG,CAACsD,IAAI,CACN,CAAC,MAAM,EAAEhB,OAAO,CAAC,+EAA+E,CAAC,CAClG,CAAC;YACJ,CAAC3B,KAAK,CAACE,MAAM,IAAIb,GAAG,CAACO,GAAG,CAAC,CAAC,QAAQ,EAAEqC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;YACjDtB,GAAE,QAAA,CAACiC,aAAa,CAACX,MAAM,EAAEQ,OAAI,QAAA,CAACI,QAAQ,CAACL,MAAM,CAAC,CAAC,CAAC;SACjD;QACD,MAAMhD,IAAI,CAACsD,YAAY,EAAE,CAAC;KAC3B,MAAM;QACL,MAAM,IAAI1D,cAAc,CAAC2D,iBAAiB,CAACzD,OAAO,CAAC,CAACwD,YAAY,EAAE,CAAC;KACpE;CACF"}