{"version":3,"sources":["../../../src/utils/scheme.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport { AndroidConfig, IOSConfig } from '@expo/config-plugins';\nimport plist from '@expo/plist';\nimport fs from 'fs';\nimport resolveFrom from 'resolve-from';\n\nimport * as Log from '../log';\nimport {\n  hasRequiredAndroidFilesAsync,\n  hasRequiredIOSFilesAsync,\n} from '../prebuild/clearNativeFolder';\nimport { intersecting } from './array';\n\n// sort longest to ensure uniqueness.\n// this might be undesirable as it causes the QR code to be longer.\nfunction sortLongest(obj: string[]): string[] {\n  return obj.sort((a, b) => b.length - a.length);\n}\n\n// TODO: Revisit and test after run code is merged.\nexport async function getSchemesForIosAsync(projectRoot: string) {\n  try {\n    const configPath = IOSConfig.Paths.getInfoPlistPath(projectRoot);\n    const rawPlist = fs.readFileSync(configPath, 'utf8');\n    const plistObject = plist.parse(rawPlist);\n    return sortLongest(IOSConfig.Scheme.getSchemesFromPlist(plistObject));\n  } catch {\n    // No ios folder or some other error\n    return [];\n  }\n}\n\n// TODO: Revisit and test after run code is merged.\nexport async function getSchemesForAndroidAsync(projectRoot: string) {\n  try {\n    const configPath = await AndroidConfig.Paths.getAndroidManifestAsync(projectRoot);\n    const manifest = await AndroidConfig.Manifest.readAndroidManifestAsync(configPath);\n    return sortLongest(await AndroidConfig.Scheme.getSchemesFromManifest(manifest));\n  } catch {\n    // No android folder or some other error\n    return [];\n  }\n}\n\n// TODO: Revisit and test after run code is merged.\nasync function getManagedDevClientSchemeAsync(projectRoot: string): Promise<string | null> {\n  const { exp } = getConfig(projectRoot);\n  try {\n    const getDefaultScheme = require(resolveFrom(projectRoot, 'expo-dev-client/getDefaultScheme'));\n    const scheme = getDefaultScheme(exp);\n    return scheme;\n  } catch {\n    Log.warn(\n      '\\nDevelopment build: Unable to get the default URI scheme for the project. Please make sure the expo-dev-client package is installed.'\n    );\n    return null;\n  }\n}\n\n// TODO: Revisit and test after run code is merged.\nexport async function getOptionalDevClientSchemeAsync(projectRoot: string): Promise<string | null> {\n  const [hasIos, hasAndroid] = await Promise.all([\n    hasRequiredIOSFilesAsync(projectRoot),\n    hasRequiredAndroidFilesAsync(projectRoot),\n  ]);\n\n  const [ios, android] = await Promise.all([\n    getSchemesForIosAsync(projectRoot),\n    getSchemesForAndroidAsync(projectRoot),\n  ]);\n\n  // Allow managed projects\n  if (!hasIos && !hasAndroid) {\n    return getManagedDevClientSchemeAsync(projectRoot);\n  }\n\n  let matching: string;\n  // Allow for only one native project to exist.\n  if (!hasIos) {\n    matching = android[0];\n  } else if (!hasAndroid) {\n    matching = ios[0];\n  } else {\n    [matching] = intersecting(ios, android);\n  }\n  return matching ?? null;\n}\n"],"names":["getSchemesForIosAsync","getSchemesForAndroidAsync","getOptionalDevClientSchemeAsync","Log","sortLongest","obj","sort","a","b","length","projectRoot","configPath","IOSConfig","Paths","getInfoPlistPath","rawPlist","fs","readFileSync","plistObject","plist","parse","Scheme","getSchemesFromPlist","AndroidConfig","getAndroidManifestAsync","manifest","Manifest","readAndroidManifestAsync","getSchemesFromManifest","getManagedDevClientSchemeAsync","exp","getConfig","getDefaultScheme","require","resolveFrom","scheme","warn","hasIos","hasAndroid","Promise","all","hasRequiredIOSFilesAsync","hasRequiredAndroidFilesAsync","ios","android","matching","intersecting"],"mappings":"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"}