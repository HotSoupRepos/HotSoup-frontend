{"version":3,"sources":["../../../src/utils/npm.ts"],"sourcesContent":["import { getExpoHomeDirectory } from '@expo/config/build/getUserState';\nimport { JSONValue } from '@expo/json-file';\nimport spawnAsync from '@expo/spawn-async';\nimport assert from 'assert';\nimport fs from 'fs';\nimport fetch from 'node-fetch';\nimport path from 'path';\nimport slugify from 'slugify';\nimport { Stream } from 'stream';\nimport tar from 'tar';\nimport { promisify } from 'util';\n\nimport { FileSystemCache } from '../api/rest/cache/FileSystemCache';\nimport { wrapFetchWithCache } from '../api/rest/cache/wrapFetchWithCache';\nimport * as Log from '../log';\nimport { createEntryResolver, createFileTransform } from './createFileTransform';\nimport { ensureDirectoryAsync } from './dir';\nimport { CommandError } from './errors';\n\nconst cachedFetch = wrapFetchWithCache(\n  fetch,\n  new FileSystemCache({\n    cacheDirectory: getCacheFilePath(),\n    // Time to live. How long (in ms) responses remain cached before being automatically ejected. If undefined, responses are never automatically ejected from the cache.\n    // ttl: 1000,\n  })\n);\n\nexport function sanitizeNpmPackageName(name: string): string {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n  return (\n    applyKnownNpmPackageNameRules(name) ||\n    applyKnownNpmPackageNameRules(slugify(name)) ||\n    // If nothing is left use 'app' like we do in Xcode projects.\n    'app'\n  );\n}\n\nfunction applyKnownNpmPackageNameRules(name: string): string | null {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n\n  // package name cannot start with '.' or '_'.\n  while (/^(\\.|_)/.test(name)) {\n    name = name.substring(1);\n  }\n\n  name = name.toLowerCase().replace(/[^a-zA-Z._\\-/@]/g, '');\n\n  return (\n    name\n      // .replace(/![a-z0-9-._~]+/g, '')\n      // Remove special characters\n      .normalize('NFD')\n      .replace(/[\\u0300-\\u036f]/g, '') || null\n  );\n}\n\nexport async function npmViewAsync(...props: string[]): Promise<JSONValue> {\n  const cmd = ['view', ...props, '--json'];\n  const results = (await spawnAsync('npm', cmd)).stdout?.trim();\n  const cmdString = `npm ${cmd.join(' ')}`;\n  Log.debug('Run:', cmdString);\n  if (!results) {\n    return null;\n  }\n  try {\n    return JSON.parse(results);\n  } catch (error: any) {\n    throw new Error(\n      `Could not parse JSON returned from \"${cmdString}\".\\n\\n${results}\\n\\nError: ${error.message}`\n    );\n  }\n}\n\n/** Given a package name like `expo` or `expo@beta`, return the registry URL if it exists. */\nexport async function getNpmUrlAsync(packageName: string): Promise<string> {\n  const results = await npmViewAsync(packageName, 'dist.tarball');\n\n  assert(results, `Could not get npm url for package \"${packageName}\"`);\n\n  // Fully qualified url returns a string.\n  // Example:\n  // ùù† npm view expo-template-bare-minimum@sdk-33 dist.tarball --json\n  if (typeof results === 'string') {\n    return results;\n  }\n\n  // When the tag is arbitrary, the tarball url is an array, return the last value as it's the most recent.\n  // Example:\n  // ùù† npm view expo-template-bare-minimum@33 dist.tarball --json\n  if (Array.isArray(results)) {\n    return results[results.length - 1] as string;\n  }\n\n  throw new CommandError(\n    'Expected results of `npm view ...` to be an array or string. Instead found: ' + results\n  );\n}\n\n// @ts-ignore\nconst pipeline = promisify(Stream.pipeline);\n\nexport async function downloadAndExtractNpmModuleAsync(\n  npmName: string,\n  props: ExtractProps\n): Promise<void> {\n  const url = await getNpmUrlAsync(npmName);\n\n  Log.debug('Fetch from URL:', url);\n  await extractNpmTarballFromUrlAsync(url, props);\n}\n\nexport async function extractLocalNpmTarballAsync(\n  tarFilePath: string,\n  props: ExtractProps\n): Promise<void> {\n  const readStream = fs.createReadStream(tarFilePath);\n  await extractNpmTarballAsync(readStream, props);\n}\n\ntype ExtractProps = {\n  name: string;\n  cwd: string;\n  strip?: number;\n  fileList?: string[];\n};\n\nfunction getCacheFilePath() {\n  return path.join(getExpoHomeDirectory(), 'template-cache');\n}\n\nasync function createUrlStreamAsync(url: string) {\n  const response = await cachedFetch(url);\n  if (!response.ok) {\n    throw new Error(`Unexpected response: ${response.statusText}. From url: ${url}`);\n  }\n\n  return response.body;\n}\n\nexport async function extractNpmTarballFromUrlAsync(\n  url: string,\n  props: ExtractProps\n): Promise<void> {\n  await extractNpmTarballAsync(await createUrlStreamAsync(url), props);\n}\n\nexport async function extractNpmTarballAsync(\n  stream: NodeJS.ReadableStream,\n  props: ExtractProps\n): Promise<void> {\n  const { cwd, strip, name, fileList = [] } = props;\n\n  await ensureDirectoryAsync(cwd);\n\n  await pipeline(\n    stream,\n    tar.extract(\n      {\n        cwd,\n        transform: createFileTransform(name),\n        onentry: createEntryResolver(name),\n        strip: strip ?? 1,\n      },\n      fileList\n    )\n  );\n}\n"],"names":["sanitizeNpmPackageName","npmViewAsync","getNpmUrlAsync","downloadAndExtractNpmModuleAsync","extractLocalNpmTarballAsync","extractNpmTarballFromUrlAsync","extractNpmTarballAsync","Log","cachedFetch","wrapFetchWithCache","fetch","FileSystemCache","cacheDirectory","getCacheFilePath","name","applyKnownNpmPackageNameRules","slugify","test","substring","toLowerCase","replace","normalize","props","cmd","results","spawnAsync","stdout","trim","cmdString","join","debug","JSON","parse","error","Error","message","packageName","assert","Array","isArray","length","CommandError","pipeline","promisify","Stream","npmName","url","tarFilePath","readStream","fs","createReadStream","path","getExpoHomeDirectory","createUrlStreamAsync","response","ok","statusText","body","stream","cwd","strip","fileList","ensureDirectoryAsync","tar","extract","transform","createFileTransform","onentry","createEntryResolver"],"mappings":"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"}