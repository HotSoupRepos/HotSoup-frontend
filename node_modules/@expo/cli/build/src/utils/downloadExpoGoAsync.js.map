{"version":3,"sources":["../../../src/utils/downloadExpoGoAsync.ts"],"sourcesContent":["import { getExpoHomeDirectory } from '@expo/config/build/getUserState';\nimport path from 'path';\nimport ProgressBar from 'progress';\n\nimport { getReleasedVersionsAsync, SDKVersion } from '../api/getVersions';\nimport * as Log from '../log';\nimport { downloadAppAsync } from './downloadAppAsync';\nimport { CommandError } from './errors';\nimport { profile } from './profile';\nimport { setProgressBar } from './progress';\n\nconst platformSettings: Record<\n  string,\n  {\n    shouldExtractResults: boolean;\n    versionsKey: keyof SDKVersion;\n    getFilePath: (filename: string) => string;\n  }\n> = {\n  ios: {\n    versionsKey: 'iosClientUrl',\n    getFilePath: (filename) =>\n      path.join(getExpoHomeDirectory(), 'ios-simulator-app-cache', `${filename}.app`),\n    shouldExtractResults: true,\n  },\n  android: {\n    versionsKey: 'androidClientUrl',\n    getFilePath: (filename) =>\n      path.join(getExpoHomeDirectory(), 'android-apk-cache', `${filename}.apk`),\n    shouldExtractResults: false,\n  },\n};\n\n/** Download the Expo Go app from the Expo servers (if only it was this easy for every app). */\nexport async function downloadExpoGoAsync(\n  platform: keyof typeof platformSettings,\n  {\n    url,\n    sdkVersion,\n  }: {\n    url?: string;\n    sdkVersion?: string;\n  }\n): Promise<string> {\n  const { getFilePath, versionsKey, shouldExtractResults } = platformSettings[platform];\n\n  const bar = new ProgressBar('Downloading the Expo Go app [:bar] :percent :etas', {\n    width: 64,\n    total: 100,\n    clear: true,\n    complete: '=',\n    incomplete: ' ',\n  });\n  // TODO: Auto track progress\n  setProgressBar(bar);\n\n  if (!url) {\n    if (!sdkVersion) {\n      throw new CommandError(\n        `Unable to determine which Expo Go version to install (platform: ${platform})`\n      );\n    }\n    const versions = await getReleasedVersionsAsync();\n    const version = versions[sdkVersion];\n    Log.debug(`Installing Expo Go version for SDK ${sdkVersion} at URL: ${version[versionsKey]}`);\n    url = version[versionsKey] as string;\n  }\n\n  const filename = path.parse(url).name;\n\n  try {\n    const outputPath = getFilePath(filename);\n    Log.debug(`Downloading Expo Go from \"${url}\" to \"${outputPath}\".`);\n    Log.debug(\n      `The requested copy of Expo Go might already be cached in: \"${getExpoHomeDirectory()}\". You can disable the cache with EXPO_NO_CACHE=1`\n    );\n    await profile(downloadAppAsync)({\n      url,\n      // Save all encrypted cache data to `~/.expo/expo-go`\n      cacheDirectory: 'expo-go',\n      outputPath,\n      extract: shouldExtractResults,\n      onProgress({ progress }) {\n        if (bar) {\n          bar.tick(1, progress);\n        }\n      },\n    });\n    return outputPath;\n  } finally {\n    bar.terminate();\n    setProgressBar(null);\n  }\n}\n"],"names":["downloadExpoGoAsync","Log","platformSettings","ios","versionsKey","getFilePath","filename","path","join","getExpoHomeDirectory","shouldExtractResults","android","platform","url","sdkVersion","bar","ProgressBar","width","total","clear","complete","incomplete","setProgressBar","CommandError","versions","getReleasedVersionsAsync","version","debug","parse","name","outputPath","profile","downloadAppAsync","cacheDirectory","extract","onProgress","progress","tick","terminate"],"mappings":"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"}