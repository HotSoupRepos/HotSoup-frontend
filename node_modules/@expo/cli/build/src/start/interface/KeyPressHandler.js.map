{"version":3,"sources":["../../../../src/start/interface/KeyPressHandler.ts"],"sourcesContent":["import * as Log from '../../log';\nimport { logCmdError } from '../../utils/errors';\n\nconst CTRL_C = '\\u0003';\n\n/** An abstract key stroke interceptor. */\nexport class KeyPressHandler {\n  private isInterceptingKeyStrokes = false;\n  private isHandlingKeyPress = false;\n\n  constructor(public onPress: (key: string) => Promise<any>) {}\n\n  /** Start observing interaction pause listeners. */\n  createInteractionListener() {\n    // Support observing prompts.\n    let wasIntercepting = false;\n\n    const listener = ({ pause }: { pause: boolean }) => {\n      if (pause) {\n        // Track if we were already intercepting key strokes before pausing, so we can\n        // resume after pausing.\n        wasIntercepting = this.isInterceptingKeyStrokes;\n        this.stopInterceptingKeyStrokes();\n      } else if (wasIntercepting) {\n        // Only start if we were previously intercepting.\n        this.startInterceptingKeyStrokes();\n      }\n    };\n\n    return listener;\n  }\n\n  private handleKeypress = async (key: string) => {\n    // Prevent sending another event until the previous event has finished.\n    if (this.isHandlingKeyPress && key !== CTRL_C) {\n      return;\n    }\n    this.isHandlingKeyPress = true;\n    try {\n      await this.onPress(key);\n    } catch (error: any) {\n      await logCmdError(error);\n    } finally {\n      this.isHandlingKeyPress = false;\n    }\n  };\n\n  /** Start intercepting all key strokes and passing them to the input `onPress` method. */\n  startInterceptingKeyStrokes() {\n    if (this.isInterceptingKeyStrokes) {\n      return;\n    }\n    this.isInterceptingKeyStrokes = true;\n    const { stdin } = process;\n    // TODO: This might be here because of an old Node version.\n    if (!stdin.setRawMode) {\n      Log.warn('Using a non-interactive terminal, keyboard commands are disabled.');\n      return;\n    }\n    stdin.setRawMode(true);\n    stdin.resume();\n    stdin.setEncoding('utf8');\n    stdin.on('data', this.handleKeypress);\n  }\n\n  /** Stop intercepting all key strokes. */\n  stopInterceptingKeyStrokes() {\n    if (!this.isInterceptingKeyStrokes) {\n      return;\n    }\n    this.isInterceptingKeyStrokes = false;\n    const { stdin } = process;\n    stdin.removeListener('data', this.handleKeypress);\n    // TODO: This might be here because of an old Node version.\n    if (!stdin.setRawMode) {\n      Log.warn('Using a non-interactive terminal, keyboard commands are disabled.');\n      return;\n    }\n    stdin.setRawMode(false);\n    stdin.resume();\n  }\n}\n"],"names":["Log","CTRL_C","KeyPressHandler","constructor","onPress","isInterceptingKeyStrokes","isHandlingKeyPress","handleKeypress","key","error","logCmdError","createInteractionListener","wasIntercepting","listener","pause","stopInterceptingKeyStrokes","startInterceptingKeyStrokes","stdin","process","setRawMode","warn","resume","setEncoding","on","removeListener"],"mappings":"AAAA;;;;AAAYA,IAAAA,GAAG,mCAAM,WAAW,EAAjB;AACa,IAAA,OAAoB,WAApB,oBAAoB,CAAA;;;;;;;;;;;;;;;;;;;;;;AAEhD,MAAMC,MAAM,GAAG,MAAQ,AAAC;AAGjB,MAAMC,eAAe;IAI1BC,YAAmBC,OAAsC,CAAE;aAAxCA,OAAsC,GAAtCA,OAAsC;aAHjDC,wBAAwB,GAAG,KAAK;aAChCC,kBAAkB,GAAG,KAAK;aAwB1BC,cAAc,GAAG,OAAOC,GAAW,GAAK;YAC9C,uEAAuE;YACvE,IAAI,IAAI,CAACF,kBAAkB,IAAIE,GAAG,KAAKP,MAAM,EAAE;gBAC7C,OAAO;aACR;YACD,IAAI,CAACK,kBAAkB,GAAG,IAAI,CAAC;YAC/B,IAAI;gBACF,MAAM,IAAI,CAACF,OAAO,CAACI,GAAG,CAAC,CAAC;aACzB,CAAC,OAAOC,KAAK,EAAO;gBACnB,MAAMC,CAAAA,GAAAA,OAAW,AAAO,CAAA,YAAP,CAACD,KAAK,CAAC,CAAC;aAC1B,QAAS;gBACR,IAAI,CAACH,kBAAkB,GAAG,KAAK,CAAC;aACjC;SACF;KAnC4D;IAE7D,mDAAmD,CACnDK,yBAAyB,GAAG;QAC1B,6BAA6B;QAC7B,IAAIC,eAAe,GAAG,KAAK,AAAC;QAE5B,MAAMC,QAAQ,GAAG,CAAC,EAAEC,KAAK,CAAA,EAAsB,GAAK;YAClD,IAAIA,KAAK,EAAE;gBACT,8EAA8E;gBAC9E,wBAAwB;gBACxBF,eAAe,GAAG,IAAI,CAACP,wBAAwB,CAAC;gBAChD,IAAI,CAACU,0BAA0B,EAAE,CAAC;aACnC,MAAM,IAAIH,eAAe,EAAE;gBAC1B,iDAAiD;gBACjD,IAAI,CAACI,2BAA2B,EAAE,CAAC;aACpC;SACF,AAAC;QAEF,OAAOH,QAAQ,CAAC;KACjB;IAiBD,yFAAyF,CACzFG,2BAA2B,GAAG;QAC5B,IAAI,IAAI,CAACX,wBAAwB,EAAE;YACjC,OAAO;SACR;QACD,IAAI,CAACA,wBAAwB,GAAG,IAAI,CAAC;QACrC,MAAM,EAAEY,KAAK,CAAA,EAAE,GAAGC,OAAO,AAAC;QAC1B,2DAA2D;QAC3D,IAAI,CAACD,KAAK,CAACE,UAAU,EAAE;YACrBnB,GAAG,CAACoB,IAAI,CAAC,mEAAmE,CAAC,CAAC;YAC9E,OAAO;SACR;QACDH,KAAK,CAACE,UAAU,CAAC,IAAI,CAAC,CAAC;QACvBF,KAAK,CAACI,MAAM,EAAE,CAAC;QACfJ,KAAK,CAACK,WAAW,CAAC,MAAM,CAAC,CAAC;QAC1BL,KAAK,CAACM,EAAE,CAAC,MAAM,EAAE,IAAI,CAAChB,cAAc,CAAC,CAAC;KACvC;IAED,yCAAyC,CACzCQ,0BAA0B,GAAG;QAC3B,IAAI,CAAC,IAAI,CAACV,wBAAwB,EAAE;YAClC,OAAO;SACR;QACD,IAAI,CAACA,wBAAwB,GAAG,KAAK,CAAC;QACtC,MAAM,EAAEY,KAAK,CAAA,EAAE,GAAGC,OAAO,AAAC;QAC1BD,KAAK,CAACO,cAAc,CAAC,MAAM,EAAE,IAAI,CAACjB,cAAc,CAAC,CAAC;QAClD,2DAA2D;QAC3D,IAAI,CAACU,KAAK,CAACE,UAAU,EAAE;YACrBnB,GAAG,CAACoB,IAAI,CAAC,mEAAmE,CAAC,CAAC;YAC9E,OAAO;SACR;QACDH,KAAK,CAACE,UAAU,CAAC,KAAK,CAAC,CAAC;QACxBF,KAAK,CAACI,MAAM,EAAE,CAAC;KAChB;CACF;QA3EYnB,eAAe,GAAfA,eAAe"}