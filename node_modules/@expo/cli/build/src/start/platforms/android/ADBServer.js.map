{"version":3,"sources":["../../../../../src/start/platforms/android/ADBServer.ts"],"sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport { execFileSync } from 'child_process';\n\nimport * as Log from '../../../log';\nimport { AbortCommandError } from '../../../utils/errors';\nimport { installExitHooks } from '../../../utils/exit';\n\nconst BEGINNING_OF_ADB_ERROR_MESSAGE = 'error: ';\n\n// This is a tricky class since it controls a system state (side-effects).\n// A more ideal solution would be to implement ADB in JS.\n// The main reason this is a class is to control the flow of testing.\n\nexport class ADBServer {\n  isRunning: boolean = false;\n  removeExitHook: () => void = () => {};\n\n  /** Returns the command line reference to ADB. */\n  getAdbExecutablePath(): string {\n    // https://developer.android.com/studio/command-line/variables\n    // TODO: Add ANDROID_SDK_ROOT support as well https://github.com/expo/expo/pull/16516#discussion_r820037917\n    if (process.env.ANDROID_HOME) {\n      return `${process.env.ANDROID_HOME}/platform-tools/adb`;\n    }\n    return 'adb';\n  }\n\n  /** Start the ADB server. */\n  async startAsync(): Promise<boolean> {\n    if (this.isRunning) {\n      return false;\n    }\n    // clean up\n    this.removeExitHook = installExitHooks(() => {\n      if (this.isRunning) {\n        this.stopAsync();\n      }\n    });\n    const adb = this.getAdbExecutablePath();\n    const result = await this.resolveAdbPromise(spawnAsync(adb, ['start-server']));\n    const lines = result.stderr.trim().split(/\\r?\\n/);\n    const isStarted = lines.includes('* daemon started successfully');\n    this.isRunning = isStarted;\n    return isStarted;\n  }\n\n  /** Kill the ADB server. */\n  async stopAsync(): Promise<boolean> {\n    Log.debug('Stopping ADB server');\n\n    if (!this.isRunning) {\n      Log.debug('ADB server is not running');\n      return false;\n    }\n    this.removeExitHook();\n    try {\n      await this.runAsync(['kill-server']);\n      return true;\n    } catch (error: any) {\n      Log.error('Failed to stop ADB server: ' + error.message);\n      return false;\n    } finally {\n      Log.debug('Stopped ADB server');\n      this.isRunning = false;\n    }\n  }\n\n  /** Execute an ADB command with given args. */\n  async runAsync(args: string[]): Promise<string> {\n    // TODO: Add a global package that installs adb to the path.\n    const adb = this.getAdbExecutablePath();\n\n    await this.startAsync();\n\n    Log.debug([adb, ...args].join(' '));\n    const result = await this.resolveAdbPromise(spawnAsync(adb, args));\n    return result.output.join('\\n');\n  }\n\n  /** Get ADB file output. Useful for reading device state/settings. */\n  async getFileOutputAsync(args: string[]): Promise<string> {\n    // TODO: Add a global package that installs adb to the path.\n    const adb = this.getAdbExecutablePath();\n\n    await this.startAsync();\n\n    const results = await this.resolveAdbPromise(\n      execFileSync(adb, args, {\n        encoding: 'latin1',\n        stdio: 'pipe',\n      })\n    );\n    Log.debug('[ADB] File output:\\n', results);\n    return results;\n  }\n\n  /** Formats error info. */\n  async resolveAdbPromise<T>(promise: T | Promise<T>): Promise<T> {\n    try {\n      return await promise;\n    } catch (error: any) {\n      // User pressed ctrl+c to cancel the process...\n      if (error.signal === 'SIGINT') {\n        throw new AbortCommandError();\n      }\n      // TODO: Support heap corruption for adb 29 (process exits with code -1073740940) (windows and linux)\n      let errorMessage = (error.stderr || error.stdout || error.message).trim();\n      if (errorMessage.startsWith(BEGINNING_OF_ADB_ERROR_MESSAGE)) {\n        errorMessage = errorMessage.substring(BEGINNING_OF_ADB_ERROR_MESSAGE.length);\n      }\n      error.message = errorMessage;\n      throw error;\n    }\n  }\n}\n"],"names":["Log","BEGINNING_OF_ADB_ERROR_MESSAGE","ADBServer","isRunning","removeExitHook","getAdbExecutablePath","process","env","ANDROID_HOME","startAsync","installExitHooks","stopAsync","adb","result","resolveAdbPromise","spawnAsync","lines","stderr","trim","split","isStarted","includes","debug","runAsync","error","message","args","join","output","getFileOutputAsync","results","execFileSync","encoding","stdio","promise","signal","AbortCommandError","errorMessage","stdout","startsWith","substring","length"],"mappings":"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"}