{"version":3,"sources":["../../../../../src/start/server/webpack/tls.ts"],"sourcesContent":["import { certificateFor } from '@expo/devcert';\nimport chalk from 'chalk';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nimport * as Log from '../../../log';\nimport { ensureDirectoryAsync } from '../../../utils/dir';\nimport { ensureDotExpoProjectDirectoryInitialized } from '../../project/dotExpo';\n\n// TODO: Move to doctor as a prereq.\n\n/** Ensure TLS is setup and environment variables are set. */\nexport async function ensureEnvironmentSupportsTLSAsync(projectRoot: string) {\n  if (!process.env.SSL_CRT_FILE || !process.env.SSL_KEY_FILE) {\n    const tls = await getTLSCertAsync(projectRoot);\n    if (tls) {\n      process.env.SSL_CRT_FILE = tls.certPath;\n      process.env.SSL_KEY_FILE = tls.keyPath;\n    }\n  }\n}\n\n/** Create TLS and write to files in the temporary directory. Exposed for testing. */\nexport async function getTLSCertAsync(\n  projectRoot: string\n): Promise<{ keyPath: string; certPath: string } | false> {\n  Log.log(\n    chalk`Creating TLS certificate for localhost. {dim This functionality may not work on all computers.}`\n  );\n\n  const name = 'localhost';\n  const result = await certificateFor(name);\n  if (result) {\n    const dotExpoDir = ensureDotExpoProjectDirectoryInitialized(projectRoot);\n\n    const { key, cert } = result;\n    const folder = path.join(dotExpoDir, 'tls');\n    const keyPath = path.join(folder, `key-${name}.pem`);\n    const certPath = path.join(folder, `cert-${name}.pem`);\n\n    await ensureDirectoryAsync(folder);\n    await Promise.allSettled([fs.writeFile(keyPath, key), fs.writeFile(certPath, cert)]);\n\n    return {\n      keyPath,\n      certPath,\n    };\n  }\n  return result;\n}\n"],"names":["ensureEnvironmentSupportsTLSAsync","getTLSCertAsync","Log","projectRoot","process","env","SSL_CRT_FILE","SSL_KEY_FILE","tls","certPath","keyPath","log","chalk","name","result","certificateFor","dotExpoDir","ensureDotExpoProjectDirectoryInitialized","key","cert","folder","path","join","ensureDirectoryAsync","Promise","allSettled","fs","writeFile"],"mappings":"AAAA;;;;QAYsBA,iCAAiC,GAAjCA,iCAAiC;QAWjCC,eAAe,GAAfA,eAAe;AAvBN,IAAA,QAAe,WAAf,eAAe,CAAA;AAC5B,IAAA,MAAO,kCAAP,OAAO,EAAA;AACV,IAAA,SAAa,kCAAb,aAAa,EAAA;AACX,IAAA,KAAM,kCAAN,MAAM,EAAA;AAEXC,IAAAA,GAAG,mCAAM,cAAc,EAApB;AACsB,IAAA,IAAoB,WAApB,oBAAoB,CAAA;AACA,IAAA,QAAuB,WAAvB,uBAAuB,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKzE,eAAeF,iCAAiC,CAACG,WAAmB,EAAE;IAC3E,IAAI,CAACC,OAAO,CAACC,GAAG,CAACC,YAAY,IAAI,CAACF,OAAO,CAACC,GAAG,CAACE,YAAY,EAAE;QAC1D,MAAMC,GAAG,GAAG,MAAMP,eAAe,CAACE,WAAW,CAAC,AAAC;QAC/C,IAAIK,GAAG,EAAE;YACPJ,OAAO,CAACC,GAAG,CAACC,YAAY,GAAGE,GAAG,CAACC,QAAQ,CAAC;YACxCL,OAAO,CAACC,GAAG,CAACE,YAAY,GAAGC,GAAG,CAACE,OAAO,CAAC;SACxC;KACF;CACF;AAGM,eAAeT,eAAe,CACnCE,WAAmB,EACqC;IACxDD,GAAG,CAACS,GAAG,CACLC,MAAK,QAAA,CAAC,+FAA+F,CAAC,CACvG,CAAC;IAEF,MAAMC,IAAI,GAAG,WAAW,AAAC;IACzB,MAAMC,MAAM,GAAG,MAAMC,CAAAA,GAAAA,QAAc,AAAM,CAAA,eAAN,CAACF,IAAI,CAAC,AAAC;IAC1C,IAAIC,MAAM,EAAE;QACV,MAAME,UAAU,GAAGC,CAAAA,GAAAA,QAAwC,AAAa,CAAA,yCAAb,CAACd,WAAW,CAAC,AAAC;QAEzE,MAAM,EAAEe,GAAG,CAAA,EAAEC,IAAI,CAAA,EAAE,GAAGL,MAAM,AAAC;QAC7B,MAAMM,MAAM,GAAGC,KAAI,QAAA,CAACC,IAAI,CAACN,UAAU,EAAE,KAAK,CAAC,AAAC;QAC5C,MAAMN,OAAO,GAAGW,KAAI,QAAA,CAACC,IAAI,CAACF,MAAM,EAAE,CAAC,IAAI,EAAEP,IAAI,CAAC,IAAI,CAAC,CAAC,AAAC;QACrD,MAAMJ,QAAQ,GAAGY,KAAI,QAAA,CAACC,IAAI,CAACF,MAAM,EAAE,CAAC,KAAK,EAAEP,IAAI,CAAC,IAAI,CAAC,CAAC,AAAC;QAEvD,MAAMU,CAAAA,GAAAA,IAAoB,AAAQ,CAAA,qBAAR,CAACH,MAAM,CAAC,CAAC;QACnC,MAAMI,OAAO,CAACC,UAAU,CAAC;YAACC,SAAE,QAAA,CAACC,SAAS,CAACjB,OAAO,EAAEQ,GAAG,CAAC;YAAEQ,SAAE,QAAA,CAACC,SAAS,CAAClB,QAAQ,EAAEU,IAAI,CAAC;SAAC,CAAC,CAAC;QAErF,OAAO;YACLT,OAAO;YACPD,QAAQ;SACT,CAAC;KACH;IACD,OAAOK,MAAM,CAAC;CACf"}