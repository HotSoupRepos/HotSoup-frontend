{"version":3,"sources":["../../../../../src/start/server/middleware/ExpoMiddleware.ts"],"sourcesContent":["import { parse } from 'url';\n\nimport * as Log from '../../../log';\nimport { ServerNext, ServerRequest, ServerResponse } from './server.types';\n\n/** Base middleware creator for Expo dev servers. */\nexport abstract class ExpoMiddleware {\n  constructor(protected projectRoot: string, protected supportedPaths: string[]) {}\n\n  /**\n   * Returns true when the middleware should handle the incoming server request.\n   * Exposed for testing.\n   */\n  _shouldHandleRequest(req: ServerRequest): boolean {\n    if (!req.url) {\n      return false;\n    }\n    const parsed = parse(req.url);\n    // Strip the query params\n    if (!parsed.pathname) {\n      return false;\n    }\n\n    return this.supportedPaths.includes(parsed.pathname);\n  }\n\n  abstract handleRequestAsync(\n    req: ServerRequest,\n    res: ServerResponse,\n    next: ServerNext\n  ): Promise<void>;\n\n  /** Create a server middleware handler. */\n  public getHandler(): (\n    req: ServerRequest,\n    res: ServerResponse,\n    next: ServerNext\n  ) => Promise<void> {\n    return async (req: ServerRequest, res: ServerResponse, next: ServerNext) => {\n      if (!this._shouldHandleRequest(req)) {\n        return next();\n      }\n\n      try {\n        return await this.handleRequestAsync(req, res, next);\n      } catch (error: any) {\n        Log.exception(error);\n        // 5xx = Server Error HTTP code\n        res.statusCode = 500;\n        if (typeof error === 'object' && error !== null) {\n          res.end(\n            JSON.stringify({\n              error: error.toString(),\n            })\n          );\n        } else {\n          res.end(`Unexpected error: ${error}`);\n        }\n      }\n    };\n  }\n}\n\nexport function disableResponseCache(res: ServerResponse): ServerResponse {\n  res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n  res.setHeader('Expires', '-1');\n  res.setHeader('Pragma', 'no-cache');\n  return res;\n}\n"],"names":["disableResponseCache","Log","ExpoMiddleware","constructor","projectRoot","supportedPaths","_shouldHandleRequest","req","url","parsed","parse","pathname","includes","getHandler","res","next","handleRequestAsync","error","exception","statusCode","end","JSON","stringify","toString","setHeader"],"mappings":"AAAA;;;;QA+DgBA,oBAAoB,GAApBA,oBAAoB;AA/Dd,IAAA,IAAK,WAAL,KAAK,CAAA;AAEfC,IAAAA,GAAG,mCAAM,cAAc,EAApB;;;;;;;;;;;;;;;;;;;;;;AAIR,MAAeC,cAAc;IAClCC,YAAsBC,WAAmB,EAAYC,cAAwB,CAAE;aAAzDD,WAAmB,GAAnBA,WAAmB;aAAYC,cAAwB,GAAxBA,cAAwB;KAAI;IAEjF;;;KAGG,CACHC,oBAAoB,CAACC,GAAkB,EAAW;QAChD,IAAI,CAACA,GAAG,CAACC,GAAG,EAAE;YACZ,OAAO,KAAK,CAAC;SACd;QACD,MAAMC,MAAM,GAAGC,CAAAA,GAAAA,IAAK,AAAS,CAAA,MAAT,CAACH,GAAG,CAACC,GAAG,CAAC,AAAC;QAC9B,yBAAyB;QACzB,IAAI,CAACC,MAAM,CAACE,QAAQ,EAAE;YACpB,OAAO,KAAK,CAAC;SACd;QAED,OAAO,IAAI,CAACN,cAAc,CAACO,QAAQ,CAACH,MAAM,CAACE,QAAQ,CAAC,CAAC;KACtD;IAQD,0CAA0C,CAC1C,AAAOE,UAAU,GAIE;QACjB,OAAO,OAAON,GAAkB,EAAEO,GAAmB,EAAEC,IAAgB,GAAK;YAC1E,IAAI,CAAC,IAAI,CAACT,oBAAoB,CAACC,GAAG,CAAC,EAAE;gBACnC,OAAOQ,IAAI,EAAE,CAAC;aACf;YAED,IAAI;gBACF,OAAO,MAAM,IAAI,CAACC,kBAAkB,CAACT,GAAG,EAAEO,GAAG,EAAEC,IAAI,CAAC,CAAC;aACtD,CAAC,OAAOE,KAAK,EAAO;gBACnBhB,GAAG,CAACiB,SAAS,CAACD,KAAK,CAAC,CAAC;gBACrB,+BAA+B;gBAC/BH,GAAG,CAACK,UAAU,GAAG,GAAG,CAAC;gBACrB,IAAI,OAAOF,KAAK,KAAK,QAAQ,IAAIA,KAAK,KAAK,IAAI,EAAE;oBAC/CH,GAAG,CAACM,GAAG,CACLC,IAAI,CAACC,SAAS,CAAC;wBACbL,KAAK,EAAEA,KAAK,CAACM,QAAQ,EAAE;qBACxB,CAAC,CACH,CAAC;iBACH,MAAM;oBACLT,GAAG,CAACM,GAAG,CAAC,CAAC,kBAAkB,EAAEH,KAAK,CAAC,CAAC,CAAC,CAAC;iBACvC;aACF;SACF,CAAC;KACH;CACF;QAvDqBf,cAAc,GAAdA,cAAc;AAyD7B,SAASF,oBAAoB,CAACc,GAAmB,EAAkB;IACxEA,GAAG,CAACU,SAAS,CAAC,eAAe,EAAE,8CAA8C,CAAC,CAAC;IAC/EV,GAAG,CAACU,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;IAC/BV,GAAG,CAACU,SAAS,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;IACpC,OAAOV,GAAG,CAAC;CACZ"}