{"version":3,"sources":["../../../../../src/run/ios/codeSigning/configureCodeSigning.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport * as Log from '../../../log';\nimport * as Security from './Security';\nimport { resolveCertificateSigningIdentityAsync } from './resolveCertificateSigningIdentity';\nimport { getCodeSigningInfoForPbxproj, setAutoCodeSigningInfoForPbxproj } from './xcodeCodeSigning';\n\nexport async function ensureDeviceIsCodeSignedForDeploymentAsync(\n  projectRoot: string\n): Promise<string | null> {\n  if (isCodeSigningConfigured(projectRoot)) {\n    return null;\n  }\n  return configureCodeSigningAsync(projectRoot);\n}\n\nfunction isCodeSigningConfigured(projectRoot: string): boolean {\n  // Check if the app already has a development team defined.\n  const signingInfo = getCodeSigningInfoForPbxproj(projectRoot);\n\n  const allTargetsHaveTeams = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.developmentTeams.length;\n  }, true);\n\n  if (allTargetsHaveTeams) {\n    const teamList = Object.values(signingInfo).reduce<string[]>((prev, curr) => {\n      return prev.concat([curr.developmentTeams[0]]);\n    }, []);\n    Log.log(chalk.dim`\\u203A Auto signing app using team(s): ${teamList.join(', ')}`);\n    return true;\n  }\n\n  const allTargetsHaveProfiles = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.provisioningProfiles.length;\n  }, true);\n\n  if (allTargetsHaveProfiles) {\n    // this indicates that the user has manual code signing setup (possibly for production).\n    return true;\n  }\n  return false;\n}\n\nasync function configureCodeSigningAsync(projectRoot: string) {\n  const ids = await Security.findIdentitiesAsync();\n\n  const id = await resolveCertificateSigningIdentityAsync(ids);\n\n  Log.log(`\\u203A Signing and building iOS app with: ${id.codeSigningInfo}`);\n\n  setAutoCodeSigningInfoForPbxproj(projectRoot, {\n    appleTeamId: id.appleTeamId!,\n  });\n  return id.appleTeamId!;\n}\n"],"names":["ensureDeviceIsCodeSignedForDeploymentAsync","Log","Security","projectRoot","isCodeSigningConfigured","configureCodeSigningAsync","signingInfo","getCodeSigningInfoForPbxproj","allTargetsHaveTeams","Object","values","reduce","prev","curr","developmentTeams","length","teamList","concat","log","chalk","dim","join","allTargetsHaveProfiles","provisioningProfiles","ids","findIdentitiesAsync","id","resolveCertificateSigningIdentityAsync","codeSigningInfo","setAutoCodeSigningInfoForPbxproj","appleTeamId"],"mappings":"AAAA;;;;QAOsBA,0CAA0C,GAA1CA,0CAA0C;AAP9C,IAAA,MAAO,kCAAP,OAAO,EAAA;AAEbC,IAAAA,GAAG,mCAAM,cAAc,EAApB;AACHC,IAAAA,QAAQ,mCAAM,YAAY,EAAlB;AACmC,IAAA,kCAAqC,WAArC,qCAAqC,CAAA;AACb,IAAA,iBAAoB,WAApB,oBAAoB,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE5F,eAAeF,0CAA0C,CAC9DG,WAAmB,EACK;IACxB,IAAIC,uBAAuB,CAACD,WAAW,CAAC,EAAE;QACxC,OAAO,IAAI,CAAC;KACb;IACD,OAAOE,yBAAyB,CAACF,WAAW,CAAC,CAAC;CAC/C;AAED,SAASC,uBAAuB,CAACD,WAAmB,EAAW;IAC7D,2DAA2D;IAC3D,MAAMG,WAAW,GAAGC,CAAAA,GAAAA,iBAA4B,AAAa,CAAA,6BAAb,CAACJ,WAAW,CAAC,AAAC;IAE9D,MAAMK,mBAAmB,GAAGC,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAC,CAACC,IAAI,EAAEC,IAAI,GAAK;QAC5E,OAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACC,gBAAgB,CAACC,MAAM,CAAC;KAC/C,EAAE,IAAI,CAAC,AAAC;IAET,IAAIP,mBAAmB,EAAE;QACvB,MAAMQ,QAAQ,GAAGP,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAW,CAACC,IAAI,EAAEC,IAAI,GAAK;YAC3E,OAAOD,IAAI,CAACK,MAAM,CAAC;gBAACJ,IAAI,CAACC,gBAAgB,CAAC,CAAC,CAAC;aAAC,CAAC,CAAC;SAChD,EAAE,EAAE,CAAC,AAAC;QACPb,GAAG,CAACiB,GAAG,CAACC,MAAK,QAAA,CAACC,GAAG,CAAC,uCAAuC,EAAEJ,QAAQ,CAACK,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;QAClF,OAAO,IAAI,CAAC;KACb;IAED,MAAMC,sBAAsB,GAAGb,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAC,CAACC,IAAI,EAAEC,IAAI,GAAK;QAC/E,OAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACU,oBAAoB,CAACR,MAAM,CAAC;KACnD,EAAE,IAAI,CAAC,AAAC;IAET,IAAIO,sBAAsB,EAAE;QAC1B,wFAAwF;QACxF,OAAO,IAAI,CAAC;KACb;IACD,OAAO,KAAK,CAAC;CACd;AAED,eAAejB,yBAAyB,CAACF,WAAmB,EAAE;IAC5D,MAAMqB,GAAG,GAAG,MAAMtB,QAAQ,CAACuB,mBAAmB,EAAE,AAAC;IAEjD,MAAMC,EAAE,GAAG,MAAMC,CAAAA,GAAAA,kCAAsC,AAAK,CAAA,uCAAL,CAACH,GAAG,CAAC,AAAC;IAE7DvB,GAAG,CAACiB,GAAG,CAAC,CAAC,0CAA0C,EAAEQ,EAAE,CAACE,eAAe,CAAC,CAAC,CAAC,CAAC;IAE3EC,CAAAA,GAAAA,iBAAgC,AAE9B,CAAA,iCAF8B,CAAC1B,WAAW,EAAE;QAC5C2B,WAAW,EAAEJ,EAAE,CAACI,WAAW;KAC5B,CAAC,CAAC;IACH,OAAOJ,EAAE,CAACI,WAAW,CAAE;CACxB"}