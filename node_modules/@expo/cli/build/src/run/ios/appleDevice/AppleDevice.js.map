{"version":3,"sources":["../../../../../src/run/ios/appleDevice/AppleDevice.ts"],"sourcesContent":["import Debug from 'debug';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { XcodeDeveloperDiskImagePrerequisite } from '../../../start/doctor/apple/XcodeDeveloperDiskImagePrerequisite';\nimport { delayAsync } from '../../../utils/delay';\nimport { CommandError } from '../../../utils/errors';\nimport { installExitHooks } from '../../../utils/exit';\nimport { ClientManager } from './ClientManager';\nimport { IPLookupResult, OnInstallProgressCallback } from './client/InstallationProxyClient';\nimport { DeviceValues, LockdowndClient } from './client/LockdowndClient';\nimport { UsbmuxdClient } from './client/UsbmuxdClient';\nimport { AFC_STATUS, AFCError } from './protocol/AFCProtocol';\n\nconst debug = Debug('expo:apple-device');\n\n// NOTE(EvanBacon): I have a feeling this shape will change with new iOS versions (tested against iOS 15).\nexport interface ConnectedDevice {\n  /** @example `00008101-001964A22629003A` */\n  udid: string;\n  /** @example `Evan's phone` */\n  name: string;\n  /** @example `iPhone13,4` */\n  model: string;\n  /** @example `device` */\n  deviceType: 'device' | 'catalyst';\n  /** @example `15.4.1` */\n  osVersion: string;\n}\n\nexport async function getConnectedDevicesAsync(): Promise<ConnectedDevice[]> {\n  const results = await getConnectedDeviceValuesAsync();\n  // TODO: Add support for osType (ipad, watchos, etc)\n  return results.map((device) => ({\n    // TODO: Better name\n    name: device.DeviceName ?? device.ProductType ?? 'unknown ios device',\n    model: device.ProductType,\n    osVersion: device.ProductVersion,\n    deviceType: 'device',\n    udid: device.UniqueDeviceID,\n  }));\n}\n\n/** @returns a list of physically connected Apple devices. */\nexport async function getConnectedDeviceValuesAsync(): Promise<DeviceValues[]> {\n  const client = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n  const devices = await client.getDevices();\n  client.socket.end();\n\n  return Promise.all(\n    devices.map(async (device): Promise<DeviceValues> => {\n      const socket = await new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket()).connect(\n        device,\n        62078\n      );\n      const deviceValue = await new LockdowndClient(socket).getAllValues();\n      socket.end();\n      return deviceValue;\n    })\n  );\n}\n\n/** Install and run an Apple app binary on a connected Apple device. */\nexport async function runOnDevice({\n  udid,\n  appPath,\n  bundleId,\n  waitForApp,\n  deltaPath,\n  onProgress,\n}: {\n  /** Apple device UDID */\n  udid: string;\n  /** File path to the app binary (ipa) */\n  appPath: string;\n  /** Bundle identifier for the app at `appPath` */\n  bundleId: string;\n  /** Wait for the app to launch before returning */\n  waitForApp: boolean;\n  /** File path to the app deltas folder to use for faster subsequent installs */\n  deltaPath: string;\n  /** Callback to be called with progress updates */\n  onProgress: OnInstallProgressCallback;\n}) {\n  const clientManager = await ClientManager.create(udid);\n\n  try {\n    await mountDeveloperDiskImage(clientManager);\n\n    const packageName = path.basename(appPath);\n    const destPackagePath = path.join('PublicStaging', packageName);\n\n    await uploadApp(clientManager, { appBinaryPath: appPath, destinationPath: destPackagePath });\n\n    const installer = await clientManager.getInstallationProxyClient();\n    await installer.installApp(\n      destPackagePath,\n      bundleId,\n      {\n        // https://github.com/ios-control/ios-deploy/blob/0f2ffb1e564aa67a2dfca7cdf13de47ce489d835/src/ios-deploy/ios-deploy.m#L2491-L2508\n        ApplicationsType: 'Any',\n\n        CFBundleIdentifier: bundleId,\n        CloseOnInvalidate: '1',\n        InvalidateOnDetach: '1',\n        IsUserInitiated: '1',\n        // Disable checking for wifi devices, this is nominally faster.\n        PreferWifi: '0',\n        // Only info I could find on these:\n        // https://github.com/wwxxyx/Quectel_BG96/blob/310876f90fc1093a59e45e381160eddcc31697d0/Apple_Homekit/homekit_certification_tools/ATS%206/ATS%206/ATS.app/Contents/Frameworks/CaptureKit.framework/Versions/A/Resources/MobileDevice/MobileInstallation.h#L112-L121\n        PackageType: 'Developer',\n        ShadowParentKey: deltaPath,\n        // SkipUninstall: '1'\n      },\n      onProgress\n    );\n\n    const { [bundleId]: appInfo } = await installer.lookupApp([bundleId]);\n    // launch fails with EBusy or ENotFound if you try to launch immediately after install\n    await delayAsync(200);\n    const debugServerClient = await launchApp(clientManager, { appInfo, detach: !waitForApp });\n    if (waitForApp) {\n      installExitHooks(async () => {\n        // causes continue() to return\n        debugServerClient.halt();\n        // give continue() time to return response\n        await delayAsync(64);\n      });\n\n      debug(`Waiting for app to close...\\n`);\n      const result = await debugServerClient.continue();\n      // TODO: I have no idea what this packet means yet (successful close?)\n      // if not a close (ie, most likely due to halt from onBeforeExit), then kill the app\n      if (result !== 'W00') {\n        await debugServerClient.kill();\n      }\n    }\n  } finally {\n    clientManager.end();\n  }\n}\n\n/** Mount the developer disk image for Xcode. */\nasync function mountDeveloperDiskImage(clientManager: ClientManager) {\n  const imageMounter = await clientManager.getMobileImageMounterClient();\n  // Check if already mounted. If not, mount.\n  if (!(await imageMounter.lookupImage()).ImageSignature) {\n    // verify DeveloperDiskImage exists (TODO: how does this work on Windows/Linux?)\n    // TODO: if windows/linux, download?\n    const version = await (await clientManager.getLockdowndClient()).getValue('ProductVersion');\n    const developerDiskImagePath = await XcodeDeveloperDiskImagePrerequisite.instance.assertAsync({\n      version,\n    });\n    const developerDiskImageSig = fs.readFileSync(`${developerDiskImagePath}.signature`);\n    await imageMounter.uploadImage(developerDiskImagePath, developerDiskImageSig);\n    await imageMounter.mountImage(developerDiskImagePath, developerDiskImageSig);\n  }\n}\n\nasync function uploadApp(\n  clientManager: ClientManager,\n  { appBinaryPath, destinationPath }: { appBinaryPath: string; destinationPath: string }\n) {\n  const afcClient = await clientManager.getAFCClient();\n  try {\n    await afcClient.getFileInfo('PublicStaging');\n  } catch (err: any) {\n    if (err instanceof AFCError && err.status === AFC_STATUS.OBJECT_NOT_FOUND) {\n      await afcClient.makeDirectory('PublicStaging');\n    } else {\n      throw err;\n    }\n  }\n  await afcClient.uploadDirectory(appBinaryPath, destinationPath);\n}\n\nasync function launchApp(\n  clientManager: ClientManager,\n  { appInfo, detach }: { appInfo: IPLookupResult[string]; detach?: boolean }\n) {\n  let tries = 0;\n  while (tries < 3) {\n    const debugServerClient = await clientManager.getDebugserverClient();\n    await debugServerClient.setMaxPacketSize(1024);\n    await debugServerClient.setWorkingDir(appInfo.Container);\n    await debugServerClient.launchApp(appInfo.Path, appInfo.CFBundleExecutable);\n\n    const result = await debugServerClient.checkLaunchSuccess();\n    if (result === 'OK') {\n      if (detach) {\n        // https://github.com/libimobiledevice/libimobiledevice/blob/25059d4c7d75e03aab516af2929d7c6e6d4c17de/tools/idevicedebug.c#L455-L464\n        const res = await debugServerClient.sendCommand('D', []);\n        debug('Disconnect from debug server request:', res);\n        if (res !== 'OK') {\n          console.warn(\n            'Something went wrong while attempting to disconnect from iOS debug server, you may need to reopen the app manually.'\n          );\n        }\n      }\n\n      return debugServerClient;\n    } else if (result === 'EBusy' || result === 'ENotFound') {\n      debug('Device busy or app not found, trying to launch again in .5s...');\n      tries++;\n      debugServerClient.socket.end();\n      await delayAsync(500);\n    } else {\n      throw new CommandError(`There was an error launching app: ${result}`);\n    }\n  }\n  throw new CommandError('Unable to launch app, number of tries exceeded');\n}\n"],"names":["getConnectedDevicesAsync","getConnectedDeviceValuesAsync","runOnDevice","debug","Debug","results","device","map","name","DeviceName","ProductType","model","osVersion","ProductVersion","deviceType","udid","UniqueDeviceID","client","UsbmuxdClient","connectUsbmuxdSocket","devices","getDevices","socket","end","Promise","all","connect","deviceValue","LockdowndClient","getAllValues","appPath","bundleId","waitForApp","deltaPath","onProgress","clientManager","ClientManager","create","mountDeveloperDiskImage","packageName","path","basename","destPackagePath","join","uploadApp","appBinaryPath","destinationPath","installer","getInstallationProxyClient","installApp","ApplicationsType","CFBundleIdentifier","CloseOnInvalidate","InvalidateOnDetach","IsUserInitiated","PreferWifi","PackageType","ShadowParentKey","appInfo","lookupApp","delayAsync","debugServerClient","launchApp","detach","installExitHooks","halt","result","continue","kill","imageMounter","getMobileImageMounterClient","lookupImage","ImageSignature","version","getLockdowndClient","getValue","developerDiskImagePath","XcodeDeveloperDiskImagePrerequisite","instance","assertAsync","developerDiskImageSig","fs","readFileSync","uploadImage","mountImage","afcClient","getAFCClient","getFileInfo","err","AFCError","status","AFC_STATUS","OBJECT_NOT_FOUND","makeDirectory","uploadDirectory","tries","getDebugserverClient","setMaxPacketSize","setWorkingDir","Container","Path","CFBundleExecutable","checkLaunchSuccess","res","sendCommand","console","warn","CommandError"],"mappings":"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"}