{"version":3,"sources":["../../../../../../src/run/ios/appleDevice/protocol/UsbmuxProtocol.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport plist from '@expo/plist';\nimport Debug from 'debug';\nimport { Socket } from 'net';\n\nimport type { ProtocolWriter } from './AbstractProtocol';\nimport { PlistProtocolReader, ProtocolClient, ProtocolReaderFactory } from './AbstractProtocol';\n\nconst debug = Debug('expo:apple-device:protocol:usbmux');\n\nexport const USBMUXD_HEADER_SIZE = 16;\n\nexport interface UsbmuxMessage {\n  messageType: string;\n  extraFields?: { [key: string]: any };\n}\n\nexport class UsbmuxProtocolClient extends ProtocolClient<UsbmuxMessage> {\n  constructor(socket: Socket) {\n    super(socket, new ProtocolReaderFactory(UsbmuxProtocolReader), new UsbmuxProtocolWriter());\n  }\n}\n\nexport class UsbmuxProtocolReader extends PlistProtocolReader {\n  constructor(callback: (data: any) => any) {\n    super(USBMUXD_HEADER_SIZE, callback);\n  }\n\n  parseHeader(data: Buffer) {\n    return data.readUInt32LE(0) - USBMUXD_HEADER_SIZE;\n  }\n\n  parseBody(data: Buffer) {\n    const resp = super.parseBody(data);\n    debug(`Response: ${JSON.stringify(resp)}`);\n    return resp;\n  }\n}\n\nexport class UsbmuxProtocolWriter implements ProtocolWriter {\n  private useTag = 0;\n\n  write(socket: Socket, msg: UsbmuxMessage) {\n    // TODO Usbmux message type\n    debug(`socket write: ${JSON.stringify(msg)}`);\n    const { messageType, extraFields } = msg;\n    const plistMessage = plist.build({\n      BundleID: 'dev.expo.native-run', // TODO\n      ClientVersionString: 'usbmux.js', // TODO\n      MessageType: messageType,\n      ProgName: 'native-run', // TODO\n      kLibUSBMuxVersion: 3,\n      ...extraFields,\n    });\n\n    const dataSize = plistMessage ? plistMessage.length : 0;\n    const protocolVersion = 1;\n    const messageCode = 8;\n\n    const header = Buffer.alloc(USBMUXD_HEADER_SIZE);\n    header.writeUInt32LE(USBMUXD_HEADER_SIZE + dataSize, 0);\n    header.writeUInt32LE(protocolVersion, 4);\n    header.writeUInt32LE(messageCode, 8);\n    header.writeUInt32LE(this.useTag++, 12); // TODO\n    socket.write(header);\n    socket.write(plistMessage);\n  }\n}\n"],"names":["debug","Debug","USBMUXD_HEADER_SIZE","UsbmuxProtocolClient","ProtocolClient","constructor","socket","ProtocolReaderFactory","UsbmuxProtocolReader","UsbmuxProtocolWriter","PlistProtocolReader","callback","parseHeader","data","readUInt32LE","parseBody","resp","JSON","stringify","useTag","write","msg","messageType","extraFields","plistMessage","plist","build","BundleID","ClientVersionString","MessageType","ProgName","kLibUSBMuxVersion","dataSize","length","protocolVersion","messageCode","header","Buffer","alloc","writeUInt32LE"],"mappings":"AAQA;;;;;AAAkB,IAAA,MAAa,kCAAb,aAAa,EAAA;AACb,IAAA,MAAO,kCAAP,OAAO,EAAA;AAIkD,IAAA,iBAAoB,WAApB,oBAAoB,CAAA;;;;;;AAE/F,MAAMA,KAAK,GAAGC,CAAAA,GAAAA,MAAK,AAAqC,CAAA,QAArC,CAAC,mCAAmC,CAAC,AAAC;AAElD,MAAMC,mBAAmB,GAAG,EAAE,AAAC;QAAzBA,mBAAmB,GAAnBA,mBAAmB;AAOzB,MAAMC,oBAAoB,SAASC,iBAAc,eAAA;IACtDC,YAAYC,MAAc,CAAE;QAC1B,KAAK,CAACA,MAAM,EAAE,IAAIC,iBAAqB,sBAAA,CAACC,oBAAoB,CAAC,EAAE,IAAIC,oBAAoB,EAAE,CAAC,CAAC;KAC5F;CACF;QAJYN,oBAAoB,GAApBA,oBAAoB;AAM1B,MAAMK,oBAAoB,SAASE,iBAAmB,oBAAA;IAC3DL,YAAYM,QAA4B,CAAE;QACxC,KAAK,CAACT,mBAAmB,EAAES,QAAQ,CAAC,CAAC;KACtC;IAEDC,WAAW,CAACC,IAAY,EAAE;QACxB,OAAOA,IAAI,CAACC,YAAY,CAAC,CAAC,CAAC,GAAGZ,mBAAmB,CAAC;KACnD;IAEDa,SAAS,CAACF,IAAY,EAAE;QACtB,MAAMG,IAAI,GAAG,KAAK,CAACD,SAAS,CAACF,IAAI,CAAC,AAAC;QACnCb,KAAK,CAAC,CAAC,UAAU,EAAEiB,IAAI,CAACC,SAAS,CAACF,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;QAC3C,OAAOA,IAAI,CAAC;KACb;CACF;QAdYR,oBAAoB,GAApBA,oBAAoB;AAgB1B,MAAMC,oBAAoB;IAC/B,AAAQU,MAAM,GAAG,CAAC,CAAC;IAEnBC,KAAK,CAACd,MAAc,EAAEe,GAAkB,EAAE;QACxC,2BAA2B;QAC3BrB,KAAK,CAAC,CAAC,cAAc,EAAEiB,IAAI,CAACC,SAAS,CAACG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9C,MAAM,EAAEC,WAAW,CAAA,EAAEC,WAAW,CAAA,EAAE,GAAGF,GAAG,AAAC;QACzC,MAAMG,YAAY,GAAGC,MAAK,QAAA,CAACC,KAAK,CAAC;YAC/BC,QAAQ,EAAE,qBAAqB;YAC/BC,mBAAmB,EAAE,WAAW;YAChCC,WAAW,EAAEP,WAAW;YACxBQ,QAAQ,EAAE,YAAY;YACtBC,iBAAiB,EAAE,CAAC;YACpB,GAAGR,WAAW;SACf,CAAC,AAAC;QAEH,MAAMS,QAAQ,GAAGR,YAAY,GAAGA,YAAY,CAACS,MAAM,GAAG,CAAC,AAAC;QACxD,MAAMC,eAAe,GAAG,CAAC,AAAC;QAC1B,MAAMC,WAAW,GAAG,CAAC,AAAC;QAEtB,MAAMC,MAAM,GAAGC,MAAM,CAACC,KAAK,CAACpC,mBAAmB,CAAC,AAAC;QACjDkC,MAAM,CAACG,aAAa,CAACrC,mBAAmB,GAAG8B,QAAQ,EAAE,CAAC,CAAC,CAAC;QACxDI,MAAM,CAACG,aAAa,CAACL,eAAe,EAAE,CAAC,CAAC,CAAC;QACzCE,MAAM,CAACG,aAAa,CAACJ,WAAW,EAAE,CAAC,CAAC,CAAC;QACrCC,MAAM,CAACG,aAAa,CAAC,IAAI,CAACpB,MAAM,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC,OAAO;QAChDb,MAAM,CAACc,KAAK,CAACgB,MAAM,CAAC,CAAC;QACrB9B,MAAM,CAACc,KAAK,CAACI,YAAY,CAAC,CAAC;KAC5B;CACF;QA5BYf,oBAAoB,GAApBA,oBAAoB"}