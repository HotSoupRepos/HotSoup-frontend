{"version":3,"file":"HermesBundler.js","sourceRoot":"","sources":["../src/HermesBundler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ExpoConfig, Platform } from '@expo/config';\nimport spawnAsync from '@expo/spawn-async';\nimport fs from 'fs-extra';\nimport os from 'os';\nimport path from 'path';\nimport process from 'process';\nimport semver from 'semver';\n\nimport {\n  importHermesCommandFromProject,\n  importMetroSourceMapComposeSourceMapsFromProject,\n} from './metro/importMetroFromProject';\n\nexport function isEnableHermesManaged(expoConfig: ExpoConfig, platform: Platform): boolean {\n  switch (platform) {\n    case 'android': {\n      if (!gteSdkVersion(expoConfig, '42.0.0')) {\n        // Hermes on Android is supported after SDK 42.\n        return false;\n      }\n      return (expoConfig.android?.jsEngine ?? expoConfig.jsEngine) === 'hermes';\n    }\n    case 'ios': {\n      if (!gteSdkVersion(expoConfig, '43.0.0')) {\n        // Hermes on iOS is supported after SDK 43.\n        return false;\n      }\n      return (expoConfig.ios?.jsEngine ?? expoConfig.jsEngine) === 'hermes';\n    }\n    default:\n      return false;\n  }\n}\n\ninterface HermesBundleOutput {\n  hbc: Uint8Array;\n  sourcemap: string;\n}\nexport async function buildHermesBundleAsync(\n  projectRoot: string,\n  code: string,\n  map: string,\n  optimize: boolean = false\n): Promise<HermesBundleOutput> {\n  const tempDir = path.join(os.tmpdir(), `expo-bundler-${process.pid}`);\n  await fs.ensureDir(tempDir);\n  try {\n    const tempBundleFile = path.join(tempDir, 'index.bundle');\n    const tempSourcemapFile = path.join(tempDir, 'index.bundle.map');\n    await fs.writeFile(tempBundleFile, code);\n    await fs.writeFile(tempSourcemapFile, map);\n\n    const tempHbcFile = path.join(tempDir, 'index.hbc');\n    const hermesCommand = importHermesCommandFromProject(projectRoot);\n    const args = ['-emit-binary', '-out', tempHbcFile, tempBundleFile, '-output-source-map'];\n    if (optimize) {\n      args.push('-O');\n    }\n    await spawnAsync(hermesCommand, args);\n\n    const [hbc, sourcemap] = await Promise.all([\n      fs.readFile(tempHbcFile),\n      createHermesSourcemapAsync(projectRoot, map, `${tempHbcFile}.map`),\n    ]);\n    return {\n      hbc,\n      sourcemap,\n    };\n  } finally {\n    await fs.remove(tempDir);\n  }\n}\n\nexport async function createHermesSourcemapAsync(\n  projectRoot: string,\n  sourcemap: string,\n  hermesMapFile: string\n): Promise<string> {\n  const composeSourceMaps = importMetroSourceMapComposeSourceMapsFromProject(projectRoot);\n  const bundlerSourcemap = JSON.parse(sourcemap);\n  const hermesSourcemap = await fs.readJSON(hermesMapFile);\n  return JSON.stringify(composeSourceMaps([bundlerSourcemap, hermesSourcemap]));\n}\n\nexport function parseGradleProperties(content: string): Record<string, string> {\n  const result: Record<string, string> = {};\n  for (let line of content.split('\\n')) {\n    line = line.trim();\n    if (!line || line.startsWith('#')) {\n      continue;\n    }\n\n    const sepIndex = line.indexOf('=');\n    const key = line.substr(0, sepIndex);\n    const value = line.substr(sepIndex + 1);\n    result[key] = value;\n  }\n  return result;\n}\n\nexport async function maybeThrowFromInconsistentEngineAsync(\n  projectRoot: string,\n  configFilePath: string,\n  platform: string,\n  isHermesManaged: boolean\n): Promise<void> {\n  const configFileName = path.basename(configFilePath);\n  if (\n    platform === 'android' &&\n    (await maybeInconsistentEngineAndroidAsync(projectRoot, isHermesManaged))\n  ) {\n    throw new Error(\n      `JavaScript engine configuration is inconsistent between ${configFileName} and Android native project.\\n` +\n        `In ${configFileName}: Hermes is ${isHermesManaged ? 'enabled' : 'not enabled'}\\n` +\n        `In Android native project: Hermes is ${isHermesManaged ? 'not enabled' : 'enabled'}\\n` +\n        `Please check the following files for inconsistencies:\\n` +\n        `  - ${configFilePath}\\n` +\n        `  - ${path.join(projectRoot, 'android', 'gradle.properties')}\\n` +\n        `  - ${path.join(projectRoot, 'android', 'app', 'build.gradle')}\\n` +\n        'Learn more: https://expo.fyi/hermes-android-config'\n    );\n  }\n\n  if (platform === 'ios' && (await maybeInconsistentEngineIosAsync(projectRoot, isHermesManaged))) {\n    throw new Error(\n      `JavaScript engine configuration is inconsistent between ${configFileName} and iOS native project.\\n` +\n        `In ${configFileName}: Hermes is ${isHermesManaged ? 'enabled' : 'not enabled'}\\n` +\n        `In iOS native project: Hermes is ${isHermesManaged ? 'not enabled' : 'enabled'}\\n` +\n        `Please check the following files for inconsistencies:\\n` +\n        `  - ${configFilePath}\\n` +\n        `  - ${path.join(projectRoot, 'ios', 'Podfile')}\\n` +\n        `  - ${path.join(projectRoot, 'ios', 'Podfile.properties.json')}\\n` +\n        'Learn more: https://expo.fyi/hermes-ios-config'\n    );\n  }\n}\n\nexport async function maybeInconsistentEngineAndroidAsync(\n  projectRoot: string,\n  isHermesManaged: boolean\n): Promise<boolean> {\n  // Trying best to check android native project if by chance to be consistent between app config\n\n  // Check android/app/build.gradle for \"enableHermes: true\"\n  const appBuildGradlePath = path.join(projectRoot, 'android', 'app', 'build.gradle');\n  if (fs.existsSync(appBuildGradlePath)) {\n    const content = await fs.readFile(appBuildGradlePath, 'utf8');\n    const isPropsReference =\n      content.search(\n        /^\\s*enableHermes:\\s*\\(findProperty\\('expo.jsEngine'\\) \\?: \"jsc\"\\) == \"hermes\",?\\s+/m\n      ) >= 0;\n    const isHermesBare = content.search(/^\\s*enableHermes:\\s*true,?\\s+/m) >= 0;\n    if (!isPropsReference && isHermesManaged !== isHermesBare) {\n      return true;\n    }\n  }\n\n  // Check gradle.properties from prebuild template\n  const gradlePropertiesPath = path.join(projectRoot, 'android', 'gradle.properties');\n  if (fs.existsSync(gradlePropertiesPath)) {\n    const props = parseGradleProperties(await fs.readFile(gradlePropertiesPath, 'utf8'));\n    const isHermesBare = props['expo.jsEngine'] === 'hermes';\n    if (isHermesManaged !== isHermesBare) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nexport async function maybeInconsistentEngineIosAsync(\n  projectRoot: string,\n  isHermesManaged: boolean\n): Promise<boolean> {\n  // Trying best to check ios native project if by chance to be consistent between app config\n\n  // Check ios/Podfile for \":hermes_enabled => true\"\n  const podfilePath = path.join(projectRoot, 'ios', 'Podfile');\n  if (fs.existsSync(podfilePath)) {\n    const content = await fs.readFile(podfilePath, 'utf8');\n    const hermesPropReferences = [\n      // sdk 45\n      /^\\s*:hermes_enabled\\s*=>\\s*flags\\[:hermes_enabled\\]\\s*\\|\\|\\s*podfile_properties\\['expo.jsEngine'\\]\\s*==\\s*'hermes',?/m,\n      // <= sdk 44\n      /^\\s*:hermes_enabled\\s*=>\\s*podfile_properties\\['expo.jsEngine'\\] == 'hermes',?\\s+/m,\n    ];\n    const isPropsReference = hermesPropReferences.reduce(\n      (prev, curr) => prev || content.search(curr) >= 0,\n      false\n    );\n    const isHermesBare = content.search(/^\\s*:hermes_enabled\\s*=>\\s*true,?\\s+/m) >= 0;\n    if (!isPropsReference && isHermesManaged !== isHermesBare) {\n      return true;\n    }\n  }\n\n  // Check Podfile.properties.json from prebuild template\n  const podfilePropertiesPath = path.join(projectRoot, 'ios', 'Podfile.properties.json');\n  if (fs.existsSync(podfilePropertiesPath)) {\n    const props = await parsePodfilePropertiesAsync(podfilePropertiesPath);\n    const isHermesBare = props['expo.jsEngine'] === 'hermes';\n    if (isHermesManaged !== isHermesBare) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// https://github.com/facebook/hermes/blob/release-v0.5/include/hermes/BCGen/HBC/BytecodeFileFormat.h#L24-L25\nconst HERMES_MAGIC_HEADER = 'c61fbc03c103191f';\n\nexport async function isHermesBytecodeBundleAsync(file: string): Promise<boolean> {\n  const header = await readHermesHeaderAsync(file);\n  return header.slice(0, 8).toString('hex') === HERMES_MAGIC_HEADER;\n}\n\nexport async function getHermesBytecodeBundleVersionAsync(file: string): Promise<number> {\n  const header = await readHermesHeaderAsync(file);\n  if (header.slice(0, 8).toString('hex') !== HERMES_MAGIC_HEADER) {\n    throw new Error('Invalid hermes bundle file');\n  }\n  return header.readUInt32LE(8);\n}\n\nasync function readHermesHeaderAsync(file: string): Promise<Buffer> {\n  const fd = await fs.open(file, 'r');\n  const buffer = Buffer.alloc(12);\n  await fs.read(fd, buffer, 0, 12, null);\n  await fs.close(fd);\n  return buffer;\n}\n\n// Cloned from xdl/src/Versions.ts, we cannot use that because of circular dependency\nfunction gteSdkVersion(expJson: Pick<ExpoConfig, 'sdkVersion'>, sdkVersion: string): boolean {\n  if (!expJson.sdkVersion) {\n    return false;\n  }\n\n  if (expJson.sdkVersion === 'UNVERSIONED') {\n    return true;\n  }\n\n  try {\n    return semver.gte(expJson.sdkVersion, sdkVersion);\n  } catch {\n    throw new Error(`${expJson.sdkVersion} is not a valid version. Must be in the form of x.y.z`);\n  }\n}\n\nasync function parsePodfilePropertiesAsync(\n  podfilePropertiesPath: string\n): Promise<Record<string, string>> {\n  try {\n    return JSON.parse(await fs.readFile(podfilePropertiesPath, 'utf8'));\n  } catch {\n    return {};\n  }\n}\n"]}